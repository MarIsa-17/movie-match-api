openapi: 3.0.0
info:
  title: Movie Match API
  version: 1.0.0
  description: API de películas con IA integrada y reportes avanzados.

servers:
  - url: http://localhost:3000
    description: Desarrollo local
  - url: https://movie-match-api-cctn.onrender.com
    description: Producción

tags:
  - name: Movies
    description: Operaciones básicas de películas
  - name: Analytics & Reports
    description: Estadísticas avanzadas y filtros especiales
  - name: AI
    description: Endpoints enriquecidos con IA
  - name: Reviews
    description: Gestión de reseñas y ratings

paths:
  /movies:
    get:
      summary: Obtener todas las películas
      tags: [Movies]
      parameters:
        - name: genre
          in: query
          schema:
            type: string
        - name: minRating
          in: query
          schema:
            type: number
      responses:
        '200':
          description: Lista de películas
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiResponse'
    post:
      summary: Crear una nueva película
      tags: [Movies]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MovieInput'
      responses:
        '201':
          description: Película creada

  /movies/{id}:
    get:
      summary: Obtener detalle de película por ID
      tags: [Movies]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Detalle de la película con sus reviews
    delete:
      summary: Eliminar película (Operación Atómica)
      description: Elimina la película y todas sus reseñas asociadas en una sola transacción.
      tags: [Movies]
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Película y reseñas eliminadas correctamente. Devuelve conteo de elementos borrados.

  # --- NUEVOS ENDPOINTS DE REPORTES ---
  /movies/reports/dashboard:
    get:
      summary: Obtener estadísticas globales (Dashboard)
      tags: [Analytics & Reports]
      responses:
        '200':
          description: Estadísticas de géneros, directores y tops.

  /movies/reports/empty:
    get:
      summary: Películas sin reseñas
      description: Lista películas que aún no han recibido ningún comentario.
      tags: [Analytics & Reports]
      responses:
        '200':
          description: Lista de películas olvidadas.

  /movies/reports/recent:
    get:
      summary: Estrenos de la última semana
      tags: [Analytics & Reports]
      responses:
        '200':
          description: Películas agregadas en los últimos 7 días.

  /movies/reports/export:
    get:
      summary: Exportar datos para análisis
      description: Devuelve un formato optimizado para análisis de datos (CSV-friendly).
      tags: [Analytics & Reports]
      responses:
        '200':
          description: Datos procesados para exportación.

  # --- IA Y REVIEWS ---
  /movies/discover:
    get:
      summary: Descubrir películas con IA
      tags: [AI]
      responses:
        '200':
          description: Contenido enriquecido.

  /movies/{movieId}/reviews:
    get:
      summary: Obtener reviews de una película
      tags: [Reviews]
      parameters:
        - name: movieId
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Lista de reviews
    post:
      summary: Crear review (Actualiza rating de película automáticamente)
      tags: [Reviews]
      parameters:
        - name: movieId
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReviewInput'
      responses:
        '201':
          description: Review creada y rating de película actualizado.

components:
  schemas:
    ApiResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: array
          items:
            $ref: '#/components/schemas/Movie'

    Movie:
      type: object
      properties:
        id: { type: integer }
        title: { type: string }
        year: { type: integer }
        genre: { type: string }
        rating: { type: number }
        poster: { type: string, nullable: true }

    MovieInput:
      type: object
      required: [title, year, genre, rating]
      properties:
        title: { type: string, example: "Parasite" }
        year: { type: integer, example: 2019 }
        genre: { type: string, example: "THRILLER" }
        rating: { type: number, example: 8.5 }

    Review:
      type: object
      properties:
        id: { type: integer }
        author: { type: string }
        comment: { type: string }
        rating: { type: integer }

    ReviewInput:
      type: object
      required: [author, comment, rating]
      properties:
        author: { type: string, example: "Marisa" }
        comment: { type: string, example: "Me encantó el giro del final." }
        rating: { type: integer, minimum: 1, maximum: 5, example: 5 }